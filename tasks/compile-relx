---
# file: ansible-role-erlang-packages/tasks/compile-relx.yml

- name: RELX | check if relx is already installed
  stat:
    path: "{{ relx_install_dir }}/relx"
  register: relx_exists

- name: RELX | get from git repository
  git: repo="{{ relx_repo_url }}"
       dest="{{ relx_tmp }}"
       version="{{ relx_version }}"
  when: not relx_exists.stat.exists
  register: relx_downloaded

- name: RELX | make
  command: chdir="{{ relx_tmp }}" rebar3 compile
  environment:
    PATH: "{{ ansible_env.PATH }}:{{ otp_install_dir }}/bin"
  when: relx_downloaded.changed
  register: relx_make

- name: RELX | install
  ansible.builtin.copy:
    remote_src: yes
    src: "{{ relx_tmp }}/relx"
    dest: "{{ relx_install_dir }}/relx"
    mode: '0655'
  when: relx_make.changed
  register: relx_install

- name: RELX | cleanup tmp
  file:
    path: "{{ relx_tmp }}"
    state: absent
  when: relx_install.changed

...
